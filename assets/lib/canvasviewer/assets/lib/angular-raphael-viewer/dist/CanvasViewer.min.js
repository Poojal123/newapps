function FormatReader(){this.mimetype=["image/png","image/jpeg"],"undefined"!=typeof PDFJS&&this.mimetype.push("application/pdf"),"undefined"!=typeof Tiff&&(this.mimetype.push("image/tif"),this.mimetype.push("image/tiff"));try{var e=$window.AudioContext||$window.webkitAudioContext||$window.mozAudioContext||$window.msAudioContext;"undefined"!=typeof e&&(this.mimetype.push("audio/x-wav"),this.mimetype.push("audio/wav"),this.mimetype.push("audio/x-ogg"),this.mimetype.push("audio/ogg"),this.mimetype.push("audio/x-mpeg"),this.mimetype.push("audio/mpeg"))}catch(t){}}FormatReader.prototype={pdfReader:function(e,t,i,o,n){function a(e,o,n){void 0==o&&(o=r.currentPage),void 0==n&&(n=e.page);var a=document.createElement("canvas"),s=a.getContext("2d");if(null!=n){e.rendering=!0,e.oldwidth=e.width,e.oldheight=e.height,0==Math.abs(e.options.zoom.value)&&(e.options.zoom.value=1);var d=n.getViewport(e.options.zoom.value,0);return a.width=d.width,a.height=d.height,n.render({canvasContext:s,viewport:d,intent:"display"}).then(function(){var n=new Image;n.onload=function(){e.width=n.width,e.height=n.height,t.controls.filmStrip?(n.pageNum=o,e.images.push(n),r.img=n,e.images.length==t.controls.totalPage&&(e.images.sort(function(e,t){return e.pageNum-t.pageNum}),e.rendered=!0,i())):(r.img=n,r.rendered=!0,i()),e.rendering=!1},n.src=a.toDataURL()})}}t.controls.toolbar&&(t.controls.image=!0,t.controls.sound=!1),this.reader=new FileReader;var r=this;return r.$q=o,r._pdfDoc=null,r.viewport=null,r.img=new Image,r.rendered=!1,r.width=-1,r.height=-1,r.oldwidth=-1,r.oldheight=-1,r.data=null,r.page=null,r.options=t,r.currentPage=-1,r.rendering=!1,r.isZoom=!1,r.images=[],r.timeout=!1,r.triggerRefresh=!1,this.refresh=function(){if(null!=r._pdfDoc&&!parent.rendering)if(r.timeout=!1,r.rendered=!1,t.controls.filmStrip){var e=1,i=[];r.images=[];for(var e=1;e<=t.controls.totalPage;e++)i.push(r._pdfDoc.getPage(e));r.$q.all(i).then(function(e){for(var t=0;t<e.length;t++)a(r,e[t].pageIndex,e[t])})}else r.currentPage!=r.options.controls.numPage?r._pdfDoc.getPage(r.options.controls.numPage).then(function(e){a(r,r.options.controls.numPage,e)}):a(r,r.options.controls.numPage,page)},this.reader.onload=function(){var e=new Uint8Array(r.reader.result);PDFJS.getDocument({data:e}).then(function(e){r._pdfDoc=e,t.controls.totalPage=e.numPages,t.controls.numPage=1,r._pdfDoc.getMetadata().then(function(e){t.info=e.info,t.info.metadata=e.metadata}),r.refresh()})},this.reader.readAsArrayBuffer(e),this},tiffReader:function(e,t,i){t.controls.toolbar&&(t.controls.image=!0,t.controls.sound=!1),this.reader=new FileReader;var o=this;return o.rendered=!1,o.tiff=null,o.img=new Image,o.data=null,o.width=-1,o.height=-1,o.options=t,o.images=[],o.currentPage=-1,o.isZoom=!0,this.refresh=function(){if(null==o.tiff&&(o.tiff=new Tiff({buffer:o.reader.result}),o.options.controls.totalPage=o.tiff.countDirectory(),o.options.controls.numPage=1,o.options.info={width:o.tiff.width(),height:o.tiff.height(),compression:o.tiff.getField(Tiff.Tag.COMPRESSION),document:o.tiff.getField(Tiff.Tag.DOCUMENTNAME),description:o.tiff.getField(Tiff.Tag.IMAGEDESCRIPTION),orientation:o.tiff.getField(Tiff.Tag.ORIENTATION),xresolution:o.tiff.getField(Tiff.Tag.XRESOLUTION),yresolution:o.tiff.getField(Tiff.Tag.YRESOLUTION)}),o.options.controls.numPage>o.options.controls.totalPage&&(o.options.controls.numPage=o.options.controls.totalPage),o.options.controls.filmStrip){o.images=[];for(var e=0;e<o.tiff.countDirectory();e++)o.tiff.setDirectory(e),0==e&&(o.width=o.tiff.width(),o.height=o.tiff.height()),o.images[e]=new Image,o.images[e].onload=function(){1==o.images.length&&(o.img=o.images[0]),i()},o.images[e].src=o.tiff.toDataURL(),o.images[e].pageNum=e}else if(o.currentPage!=o.options.controls.numPage){var t=new Image;t.onload=function(){o.img=t,i(),o.rendered=!0},o.tiff.setDirectory(o.options.controls.numPage-1),o.width=o.tiff.width(),o.height=o.tiff.height(),t.src=o.tiff.toDataURL(),o.currentPage=o.options.controls.numPage}},this.reader.onload=function(){null!=o.tiff&&(o.tiff.close(),o.tiff=null),Tiff.initialize({TOTAL_MEMORY:83886080}),o.refresh()},this.reader.readAsArrayBuffer(e),this},imageReader:function(e,t,i){t.controls.toolbar&&(t.controls.image=!0,t.controls.sound=!1),this.reader=new FileReader;var o=this;return o.img=new Image,o.img.onload=function(){o.width=o.img.width,o.height=o.img.height,i(),o.rendered=!0},o.data=null,o.width=-1,o.height=-1,t.info={},o.isZoom=!0,o.rendered=!1,this.reader.onload=function(){o.img.src=o.reader.result},"string"==typeof e?o.img.src=e:this.reader.readAsDataURL(e),t.controls.totalPage=1,t.controls.numPage=1,this.refresh=function(){},this},mpegReader:function(e,t,i){},wavReader:function(e,t,i){t.controls.toolbar&&(t.controls.image=!1,t.controls.sound=!0),this.reader=new FileReader;var o=this,n=t.ctx;this.width=n.canvas.width,this.height=n.canvas.height;try{$window.AudioContext=$window.AudioContext||$window.webkitAudioContext||$window.mozAudioContext||$window.msAudioContext,$window.requestAnimationFrame=$window.requestAnimationFrame||$window.webkitRequestAnimationFrame||$window.mozRequestAnimationFrame||$window.msRequestAnimationFrame,$window.cancelAnimationFrame=$window.cancelAnimationFrame||$window.webkitCancelAnimationFrame||$window.mozCancelAnimationFrame||$window.msCancelAnimationFrame;var a=new AudioContext;this.reader.onload=function(){a.decodeAudioData(o.reader.result,function(e){var i=n.createLinearGradient(0,0,0,o.height);i.addColorStop(1,"#000000"),i.addColorStop(.75,"#ff0000"),i.addColorStop(.25,"#ffff00"),i.addColorStop(0,"#ffffff");var r=a.createScriptProcessor(2048,1,1),s=a.createBufferSource();t.adsrc=s,s.buffer=e;var d=a.createAnalyser();d.smoothingTimeConstant=.3,d.fftSize=512,s.connect(d),d.connect(r),r.onaudioprocess=function(){var e=new Uint8Array(d.frequencyBinCount);d.getByteFrequencyData(e),n.clearRect(0,0,n.canvas.width,n.canvas.height),n.fillStyle=i;for(var t=0;t<e.length;t++){var a=e[t];n.fillRect(5*t,o.height-a,3,o.height)}},r.connect(a.destination),s.connect(a.destination)})},this.reader.readAsArrayBuffer(e)}catch(r){}},CreateReader:function(e,t){var i=null;switch(""==e&&(e=this.GuessMimeType(t)),e.toLowerCase()){case"image/tif":case"image/tiff":i={create:this.tiffReader};break;case"application/pdf":i={create:this.pdfReader};break;case"image/png":case"image/jpeg":i={create:this.imageReader};break;case"audio/x-wav":case"audio/wav":case"audio/x-ogg":case"audio/ogg":i={create:this.wavReader};break;case"audio/x-mpeg":case"audio/mpeg":i={create:this.mpegReader}}return i},IsSupported:function(e){return-1!=this.mimetype.indexOf(e)},GuessMimeType:function(e){var t="";if(""==e.type){var i=e.name;t="image/"+i.substring(i.indexOf(".")+1)}return t.toLowerCase()}};
angular.module("CanvasViewer",[]).directive("canvasViewer",["$window","$http","$timeout","$q",function(o,t,e,n){var i=new FormatReader;return{scope:{imageSource:"=src",overlays:"=overlays",title:"@title",options:"=options"},restrict:"E",template:'<div class="viewer-container"><canvas class="viewer" ng-mouseleave="canMove=false"ng-mousedown="mousedown($event)"ng-mouseup="mouseup($event)"ng-init="canMove=false"ng-mousemove="mousedrag($event,canMove)"></canvas><div class="title" ng-if="title!=null">{{title}}</div><div class="command" ng-if="options.controls.image"><div class="btn btn-info" ng-click="options.controls.numPage=options.controls.numPage-1" ng-hide="options.controls.totalPage==1"><i class="fa fa-minus"></i></div><div class="btn btn-info" ng-hide="options.controls.totalPage==1">{{options.controls.numPage}}/{{options.controls.totalPage}}</div><div class="btn btn-info" ng-click="options.controls.numPage=options.controls.numPage+1" ng-hide="options.controls.totalPage==1"><i class="fa fa-plus"></i></div><div class="btn btn-info" ng-click="resizeTo(\'page\')"><i class="fa fa-file-o"></i></div><div class="btn btn-info" ng-click="rotate(-1)" ng-hide="options.controls.disableRotate"><i class="fa fa-rotate-left"></i></div><div class="btn btn-info" ng-click="rotate(1)" ng-hide="options.controls.disableRotate"><i class="fa fa-rotate-right"></i></div><div class="btn btn-info" ng-click="zoom(-1)" ng-hide="options.controls.disableZoom"><i class="fa fa-search-minus"></i></div><div class="btn btn-info" ng-click="zoom(1)" ng-hide="options.controls.disableZoom"><i class="fa fa-search-plus"></i></div></div><div class="command" ng-if="options.controls.sound"><div class="btn btn-info" ng-click="stop()"><i class="fa fa-stop"></i></div><div class="btn btn-info" ng-click="play()"><i class="fa fa-play"></i></div></div></div>',link:function(t,a,s,l){function c(){null!=z&&(z.rendered?r():t.resizeTo(t.options.controls.fit))}function r(){if(null!=z){var o=t.options,e=d.canvas,n=z.width*o.zoom.value/2,i=z.height*o.zoom.value/2;if(d.clearRect(0,0,e.width,e.height),d.save(),d.translate(y.x+n,y.y+i),d.rotate(o.rotate.value*Math.PI/180),d.translate(-n,-i),z.isZoom&&d.scale(o.zoom.value,o.zoom.value),null!=z.data){var a=d.createImageData(z.width,z.height);a.data.set(z.data),d.putImageData(a,0,0)}o.controls.filmStrip&&1!=o.controls.totalPage?null!=z.images&&angular.forEach(z.images,function(o){d.drawImage(o,0,0,o.width,o.height),d.beginPath(),d.rect(0,0,o.width,o.height),d.lineWidth=.2,d.strokeStyle="#000000",d.stroke(),d.translate(0,o.height+15)}):null!=z.img&&(d.drawImage(z.img,0,0,z.width,z.height),d.beginPath(),d.rect(0,0,z.width,z.height),d.lineWidth=.2,d.strokeStyle="#000000",d.stroke()),d.restore(),w.length>0&&angular.forEach(w,function(t){d.save(),d.translate(y.x+n,y.y+i),d.rotate(o.rotate.value*Math.PI/180),d.translate(-n,-i),d.scale(o.zoom.value,o.zoom.value),d.beginPath(),d.rect(t.x,t.y,t.w,t.h),d.fillStyle=t.color,d.globalAlpha=.4,d.fill(),d.lineWidth=1,d.strokeStyle=t.color,d.stroke(),d.restore()})}}function u(){t.$applyAsync(function(){var o=h.parentNode;d.canvas.width=o.clientWidth,d.canvas.height=o.clientHeight,r()})}function p(){return g.width!=h.parentNode.clientWidth&&(g.width=h.parentNode.clientWidth),g.height!=h.parentNode.clientHeight&&(g.height=h.parentNode.clientHeight),g}var h=a.find("canvas")[0],d=h.getContext("2d"),v=angular.element(a.find("div")[0])[0];directiveParentNode=v.parentNode.parentNode;var m=h.parentNode;d.canvas.width=m.clientWidth,d.canvas.height=m.clientHeight;var g={height:m.clientHeight,width:m.clientWidth},f={x:0,y:0},y={x:0,y:0},b={x:0,y:0},w=[],z=null;t.options=angular.merge({},{ctx:null,adsrc:null,zoom:{value:1,step:.1,min:.05,max:6},rotate:{value:0,step:90},controls:{toolbar:!0,image:!0,sound:!1,fit:"page",disableZoom:!1,disableMove:!1,disableRotate:!1,numPage:1,totalPage:1,filmStrip:!1},info:{}},t.options),t.options.ctx=d,t.$watch("imageSource",function(o){if(void 0!==o&&null!==o)if(t.options.zoom.value=1,t.options.rotate.value=0,f={x:0,y:0},y={x:0,y:0},"object"==typeof o)if(i.IsSupported(o.type)){var a=i.CreateReader(o.type,o);z=a.create(o,t.options,c,n,e)}else console.log(o.type," not supported !");else"string"==typeof o&&(z=i.CreateReader("image/jpeg").create(o,t.options,c,n,e))}),t.$watch("overlays",function(o,t){null!==o&&null!==t&&(w=[],angular.forEach(o,function(o){w.push(o)}),r())},!0),t.$watch("options.zoom.value",function(){t.options.controls.disableZoom||r()}),t.$watch("options.rotate.value",function(){t.options.controls.disableRotate||r()}),t.$watch("options.controls.fit",function(o){t.resizeTo(o)}),t.$watch("options.controls.filmStrip",function(o){o?(t.options.controls.disableMove=!0,t.options.controls.disableRotate=!0):(t.options.controls.disableMove=!1,t.options.controls.disableRotate=!1),null!=z.refresh&&z.refresh()}),t.$watch("options.controls.numPage",function(o){t.options.controls.numPage<1&&(t.options.controls.numPage=1),t.options.controls.numPage>t.options.controls.totalPage&&(t.options.controls.numPage=t.options.controls.totalPage),null!=z&&(t.options.controls.filmStrip?(y.y=(t.options.controls.numPage-1)*-(z.height+15),r()):null!=z.refresh&&z.refresh())}),angular.element(h).bind("DOMMouseScroll mousewheel onmousewheel",function(o){var e=window.event||o,n=Math.max(-1,Math.min(1,e.wheelDelta||-e.detail));t.options.controls.filmStrip?(y.y+=50*n,y.y>15&&(y.y=15),z.images?y.y-z.height*t.options.zoom.value<-(z.height+15)*z.images.length*t.options.zoom.value&&(y.y=-(z.height+15)*z.images.length+z.height):y.y-z.height*t.options.zoom.value<-z.height*t.options.zoom.value&&(y.y=-z.height*t.options.zoom.value),t.$applyAsync(function(){r()})):n>0?t.zoom(1):t.zoom(-1),e.returnValue=!1,e.preventDefault&&e.preventDefault()}),angular.element(h).bind("mousedown",function(o){t.options.controls.disableMove||(t.canMove=!0,f.x=o.offsetX,f.y=o.offsetY)}),angular.element(h).bind("mouseup",function(o){t.options.controls.disableMove||(t.canMove=!1)}),angular.element(h).bind("mousemove",function(o){if(b.x=o.offsetX,b.y=o.offsetY,!t.options.controls.disableMove&&null!==z&&t.canMove){var e=o.offsetX,n=o.offsetY,i=e-f.x,a=n-f.y;y.x+=i,y.y+=a,r(),f.x=e,f.y=n}}),t.zoom=function(o){t.$applyAsync(function(){var e,n,i=0,a=0;z.isZoom?(e=z.width*t.options.zoom.value,n=z.height*t.options.zoom.value):(e=z.oldwidth,n=z.height),t.options.zoom.value+=t.options.zoom.step*o,t.options.zoom.value=Math.round(100*t.options.zoom.value)/100,t.options.zoom.value>=t.options.zoom.max&&(t.options.zoom.value=t.options.zoom.max),t.options.zoom.value<=t.options.zoom.min&&(t.options.zoom.value=t.options.zoom.min),null!=z.refresh&&z.refresh(),z.isZoom?(i=z.width*t.options.zoom.value,a=z.height*t.options.zoom.value):(i=z.width,a=z.height),y.x=y.x-(i-e)/2,y.y=y.y-(a-n)/2})},t.rotate=function(o){t.$applyAsync(function(){t.options.rotate.value+=t.options.rotate.step*o,(t.options.rotate.value<=-360||t.options.rotate.value>=360)&&(t.options.rotate.value=0),r()})};var P=function(){var o=d.canvas.width/2,e=0;e=o-z.width*t.options.zoom.value/2,f={x:e,y:0},y={x:e,y:0}};t.resizeTo=function(o){if(null!=d.canvas&&null!=z){var e=(t.options,d.canvas.height/z.height),n=d.canvas.width/z.width;switch(z.isZoom||(e*=t.options.zoom.value,n*=t.options.zoom.value),o){case"width":t.options.zoom.value=n;break;case"height":t.options.zoom.value=e;break;case"page":default:t.options.zoom.value=Math.min(e,n)}t.$applyAsync(function(){t.options.zoom.value=Math.round(100*t.options.zoom.value)/100,t.options.controls.fit=o,z.isZoom?(P(),r()):(null!=z.refresh&&z.refresh(),P())})}},t.play=function(){null!=t.options.adsrc&&t.options.adsrc.start(0)},t.stop=function(){null!=t.options.adsrc&&t.options.adsrc.stop(0)},t.$watch(p,function(){u()},!0),angular.element(o).bind("resize",function(){u()})}}}]);